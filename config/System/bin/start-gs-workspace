#!/bin/bash -x

function cleanup {
  rm /tmp/$UID-gsworkspace.pid 2>/dev/null
 }

function start_services {
  echo "making services"
  /Library/bin/make_services

  echo "about to start Notification Center"
  /Library/bin/gdnc --daemon &
  echo "$!" > /tmp/$UID-gdnc.pid

  echo "about to start Pasteboard Service"
  /Library/bin/gpbs --daemon &
  echo "$!" > /tmp/$UID-gpbs.pid
}

function start_workspace {
  echo "about to start Workspace"
  /Applications/GWorkspace.app/GWorkspace

  PID=`cat /tmp/$UID-wm.pid`
  if [ -n "x$PID" ];then
    echo "Workspace finished, killing WM at $PID"
    kill $PID 2> /dev/null
  fi

  PID=`cat /tmp/$UID-gdnc.pid`
  if [ -n "x$PID" ];then
    kill -9 $PID 2> /dev/null
  fi

  PID=`cat /tmp/$UID-gpbs.pid`
  if [ -n "x$PID" ];then
    kill -9 $PID 2> /dev/null
  fi
}

if [ -f "/tmp/$UID-gsworkspace.pid" ];then
  echo "Workspace is running already"
  gopen /Application/GWorkspace.app
else
  echo "$$" > /tmp/$UID-gsworkspace.pid
  start_services
  start_workspace
  cleanup
fi 
