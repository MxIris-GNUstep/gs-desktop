#!/bin/bash

if [ "$1" == "--safe" ];then
  export GS_DESKTOP_SAFEMODE="safe"
  exec xterm -e "$0" --safe-ask
fi

export WMAKER_USER_ROOT=$HOME/Library/WindowMaker
export PATH=/System/bin:$PATH
export RUNTIME_VERSION="gnustep-2.0"
export GS_DESKTOP_LOG=/tmp/$UID-gs-desktop.log

source /Developer/Makefiles/GNUstep.sh

if [ "$1" == "--safe-ask" ];then
  echo "running in a SAFE mode"
  read
  exec $SHELL
fi

if [ -n "$GS_DESKTOP_SAFEMODE" ];then
  WM_ARGS="--static --dont-restore"
  export GS_DESKTOP_LOG=/dev/stdout
fi

echo "starting GS Desktop"             > "$GS_DESKTOP_LOG"

if [ ! -f "$HOME/Library/Preferences/NSGlobalDomain.plist" ];then
  mkdir "$HOME/Library/Preferences" 2>/dev/null
  cp /Library/Preferences/* "$HOME/Library/Preferences/"
fi

(/System/bin/wmaker $WM_ARGS >> "$GS_DESKTOP_LOG" 2>&1) &
WM_PID=$!

echo "WM is running on $WM_PID"       >> "$GS_DESKTOP_LOG"
echo "$WM_PID" > /tmp/$UID-wm.pid
wait "$WM_PID"

echo "finishing GS Desktop"           >> "$GS_DESKTOP_LOG"
